#!/usr/bin/env python3

import os
import sys
import argparse
import multiprocessing as mp
from pprint import pprint as pp
import pymysql


DEFAULT_PORT = 3306
DEFAULTS_FILE = "~/.my.cnf"
DEFAULTS_GROUP = "client"


class db:
    def __init__(sql: str,
            hostname: str,
            port: int=DEFAULT_PORT,
            read_default_file: str=DEFAULTS_FILE,
            read_default_group: str=DEFAULTS_GROUP,
            dict_results: bool=False):
        self.sql = (sql[:-1] if sql.endswith(";") else args.sql).split(";")
        self.hostname = hostname
        self.port = port
        self.read_default_file = read_default_file
        self.read_default_group = read_default_group
        self.connect_kwargs = {'hostname': hostname, 'port': port, 'read_default_file': read_default_file, 'read_default_group': read_default_group}
        self.connect_kwargs['cursorclass'] = pymysql.cursors.DictCursor
        self.query_results = []

    def connect(self):
        return pymysql.connect(**self.connect_kwargs)

    def query(self, sql: list):
        c = self.connect()
        cur = c.cursor()
        for q in sql:
            try:
                cur.execute(q)
                rows = cur.fetchall()
            finally:
                cur.close()
        if rows:
            if len(rows) == 1:
                self.query_results.append(rows[0])
            else:
                self.query_results.append(rows)
        else:
            return

    def print_result(self):
        return

    def print_all_results(self):
        return


def cli_args():
    parser = argparse.ArgumentParser()
    parser.add_argument('--hosts', required=True,
                        help=("Comma separated list of host:port"
                              "E.g. --hosts=host:port,host"))
    parser.add_argument('--defaults-file', default=DEFAULTS_FILE)
    parser.add_argument('--defaults-group', default=DEFAULTS_GROUP)
    parser.add_argument('sql')
    args = parser.parse_args()


def parse_cli_args(args=cli_args()):
    "Split by host, and create kwargs for db class."
    host_list = list([i.split(':') for i in args.hosts.split(',')])
    db_kwargs = []
    for host in host_list:
        h = {'sql': args.sql,
             'read_default_group': args.read_default_group,
             'read_default_file': args.read_default_file}
        if len(host) == 1:
            h['port'] = DEFAULT_PORT
        else:
            h['port'] == host[1]
        h['host'] = host[0]
        db_kwargs.append(h)
    return db_kwarg


def mqm(db_args=parse_cli_args()):
    with mp.Pool() as pool:
        r = pool.starmap(mqm_query, db_args)
    for t in r:
        print_table(*t)


def mqm_query(db_args):
    my_db = db(**db_args)
    my_db.query()
    my_db.print_all_results()


if __name__ == "__main__":
    mqm()

